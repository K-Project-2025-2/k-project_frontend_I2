# 택시 채팅방 전체 흐름 상세 가이드

## 개요

택시 합승 방의 전체 흐름을 방장과 이용자 입장에서 상세히 정리한 문서입니다.

---

## 전체 흐름 개요

```
1. 방 생성 (방장)
   ↓
2. 이용자 입장 (자유롭게 입장/퇴장 가능)
   ↓
3. 인원 가득 참
   ↓
4. 방장이 운행 시작 버튼 클릭
   ↓
5. 이용자들이 운행 수락 버튼 클릭 (게이지 1/4 → 2/4 → 3/4 → 4/4)- 채팅방 못 나감
   ↓
6. 모든 인원 수락 완료 → "운행이 시작되었습니다." 표시
   ↓
7. 목적지 도착 → 방장이 정산 버튼으로 금액 입력
   ↓
8. 채팅방에 정산 금액 표시
   ↓
9. 이용자들이 송금 완료 버튼 클릭 → "@@@님 송금완료" 표시
   ↓
10. 모든 이용자 송금 완료 → 채팅방 나가기 가능
```

---

## 방장 입장 흐름

### 1. 방 생성 단계

**동작**:
- 방장이 택시 화면에서 "방 만들기" 버튼 클릭
- 출발지, 도착지, 최대 인원 수, 만남 시간 입력
- 방 생성 완료

**제약사항**:
- 사용자는 방을 1개만 생성할 수 있음
- 이미 방이 있으면 "기존의 방을 나가주세요" 알럿 표시

**API 호출**:
- `POST /api/taxi/rooms` - 방 생성

---

### 2. 이용자 입장 대기 단계

**동작**:
- 다른 이용자들이 방에 입장
- 인원 수가 실시간으로 업데이트됨 (예: 1/4 → 2/4 → 3/4 → 4/4)
- 채팅방 상단 헤더와 택시 화면 목록에 인원 수가 PNG로 표시됨

**특징**:
- 운행 시작 전에는 이용자들이 자유롭게 입장/퇴장 가능
- 입장/퇴장 시 인원 수가 실시간으로 반영됨

**API 호출**:
- `GET /api/taxi/rooms/{roomCode}` - 방 정보 조회 (Polling)

---

### 3. 운행 시작 단계

**동작**:
- 인원이 가득 찬 후, 방장이 "운행 시작" 버튼 클릭
- 방장은 자동으로 이용 동의 처리됨
- 나머지 이용자들에게 "출발 수락하기" 버튼이 표시됨

**게이지 표시**:
- 게이지가 1/4로 시작 (방장 자동 수락)
- 이용자 1명 수락 → 2/4
- 이용자 2명 수락 → 3/4
- 이용자 3명 수락 → 4/4 (모든 인원 수락 완료)

**API 호출**:
- `POST /api/taxi/rooms/{roomCode}/operation/start` - 운행 시작

---

### 4. 모든 인원 수락 완료

**동작**:
- 모든 이용자가 운행 수락 버튼을 클릭
- 게이지가 4/4로 가득 참
- 채팅방에 "운행이 시작되었습니다." 텍스트 표시
- 이제 정산 기능 사용 가능

**API 호출**:
- `GET /api/taxi/rooms/{roomCode}/operation/status` - 운행 상태 조회 (Polling)

---

### 5. 정산 단계

**동작**:
- 목적지 도착 후, 방장이 "정산" 버튼 클릭
- 총 금액 입력 (예: 12000원)
- 인원 수에 맞게 1인당 금액 자동 계산 (예: 4명이면 3000원)
- 채팅방에 정산 금액이 표시됨

**버튼 제한**:
- 방장은 토스 송금 버튼 비활성화 (터치 불가)
- 방장은 카카오페이 송금 버튼 비활성화 (터치 불가)
- 방장의 "계좌 요청" 버튼이 "계좌 보내기" 버튼으로 변경됨

**API 호출**:
- `POST /api/taxi/rooms/{roomCode}/split` - 정산 생성

---

### 6. 계좌 전송 단계

**동작**:
- 이용자가 "계좌 요청하기" 버튼 클릭
- 채팅방에 "이용자님이 계좌를 요청하였습니다." 메시지 표시
- 방장이 "계좌 보내기" 버튼 클릭
- 방장의 계좌 정보가 채팅방에 전송됨

**API 호출**:
- `GET /me/account` - 내 계좌 정보 조회
- `POST /api/taxi/rooms/{roomCode}/account/send` - 계좌 정보 전송

---

### 7. 송금 완료 확인 단계

**동작**:
- 이용자들이 각자 송금 완료 후 "송금 완료" 버튼 클릭
- 채팅방에 "@@@님 송금완료" 메시지가 표시됨
- 모든 이용자가 송금 완료하면 채팅방 나가기 가능

**API 호출**:
- `POST /api/taxi/rooms/{roomCode}/payment/complete` - 송금 완료 알림

---

## 이용자 입장 흐름

### 1. 방 입장 단계

**동작**:
- 택시 화면에서 방 목록 확인
- 원하는 방 선택 또는 초대 코드 입력
- 방에 입장

**특징**:
- 운행 시작 전에는 여러 방을 자유롭게 입장/퇴장 가능
- 입장/퇴장 시 인원 수가 실시간으로 반영됨

**API 호출**:
- `POST /api/taxi/rooms/join` - 방 입장
- `GET /api/taxi/rooms/{roomCode}` - 방 정보 조회

---

### 2. 운행 수락 단계

**동작**:
- 방장이 "운행 시작" 버튼을 클릭하면
- 이용자에게 "출발 수락하기" 버튼이 표시됨
- 이용자가 버튼 클릭하여 이용 동의

**게이지 표시**:
- 게이지가 실시간으로 업데이트됨 (1/4 → 2/4 → 3/4 → 4/4)
- 수락 완료 시 "✓ 수락 완료" 표시

**제약사항**:
- 운행 수락 후에는 채팅방을 나갈 수 없음
- 정산 완료 후에만 나갈 수 있음

**API 호출**:
- `POST /api/taxi/rooms/{roomCode}/operation/accept` - 운행 수락
- `GET /api/taxi/rooms/{roomCode}/operation/status` - 운행 상태 조회 (Polling)

---

### 3. 정산 확인 단계

**동작**:
- 방장이 정산 금액을 입력하면
- 채팅방에 1인당 금액이 표시됨 (예: 3000원)
- 이용자는 토스 송금, 카카오페이 송금, 계좌 요청 중 선택 가능

**계좌 요청**:
- 이용자가 "계좌 요청하기" 버튼 클릭
- 채팅방에 "이용자님이 계좌를 요청하였습니다." 메시지 표시
- 방장이 계좌 정보를 전송하면 채팅방에 계좌 정보 표시

**API 호출**:
- `GET /api/taxi/rooms/{roomCode}/split` - 정산 정보 조회 (Polling)

---

### 4. 송금 완료 단계

**동작**:
- 이용자가 송금 완료 후 "송금 완료" 버튼 클릭
- 채팅방에 "@@@님 송금완료" 메시지 표시
- 모든 이용자가 송금 완료하면 채팅방 나가기 가능

**버튼 위치**:
- 정산 버튼 아래 레이아웃에 "송금 완료" 버튼 추가

**API 호출**:
- `POST /api/taxi/rooms/{roomCode}/payment/complete` - 송금 완료 알림

---

## 채팅방 나가기 제한 로직

### 나가기 불가능한 경우

**운행 수락 후 정산 완료 후 송금 완료 전** (운행 수락한 이용자만)
- 이용자가 운행 수락 버튼을 클릭한 후
- 방장이 정산을 생성한 후
- 해당 이용자가 송금 완료 버튼을 클릭하기 전까지는 나갈 수 없음
- 알럿: "송금 완료 후 채팅방을 나갈 수 있습니다."

**참고**: 방장은 운행 수락 제한이 없으므로 언제든 나갈 수 있음

### 나가기 가능한 경우

1. **운행 시작 전**
   - 방장이 "운행 시작" 버튼을 클릭하기 전
   - 이용자들이 "출발 수락하기" 버튼을 클릭하기 전
   - 자유롭게 입장/퇴장 가능

2. **운행 수락 후 정산 완료 전**
   - 이용자가 운행 수락 버튼을 클릭한 후
   - 방장이 정산을 생성하기 전까지는 나갈 수 있음

3. **정산 완료 후 송금 완료 후**
   - 이용자가 송금 완료 버튼을 클릭한 후
   - 채팅방 나가기 가능

4. **방장**
   - 방장은 언제든 나갈 수 있음 (운행 수락 제한 없음)

---

## 정산 버튼 활성화 조건

### 정산 버튼 활성화

- **조건**: "운행이 시작되었습니다." 메시지가 표시된 후
- **동작**: 정산 버튼 클릭 가능

### 정산 버튼 비활성화

- **조건**: "운행이 시작되었습니다." 메시지가 표시되기 전
- **동작**: 정산 버튼 클릭 시 알럿 표시
- **알럿 메시지**: "운행을 시작해야 작동됩니다."

---

## 액션 그리드 버튼 레이아웃

### 첫 번째 행 (3개)
- 토스 송금
- 운행 시작/출발
- 정산

### 두 번째 행 (1개)
- 카카오페이 송금
- 빈 버튼
- 빈 버튼

### 세 번째 행 (3개)
- 계좌 요청 / 계좌 보내기 (방장만)
- 신고
- 채팅방 나가기

### 정산 버튼 아래 (새로 추가)
- 송금 완료 버튼 (방장 제외 이용자만)

---

## 방장 vs 이용자 버튼 차이

### 방장만 가능한 기능
- 운행 시작
- 정산 생성
- 계좌 보내기 (정산 후)

### 방장 제한 기능
- 토스 송금 (정산 후 비활성화)
- 카카오페이 송금 (정산 후 비활성화)
- 송금 완료 버튼 (표시 안 됨)

### 이용자만 가능한 기능
- 운행 수락
- 계좌 요청
- 송금 완료

### 이용자 제한 기능
- 운행 시작 (버튼 비활성화)
- 정산 생성 (버튼 비활성화)
- 계좌 보내기 (버튼 없음)

---

## 실시간 업데이트

### Polling 주기

1. **메시지**: 3초마다
2. **운행 상태**: 3초마다 (운행 시작 후)
3. **정산 상태**: 3초마다 (정산 생성 후)
4. **방 정보**: 3초마다 (인원 수 업데이트)

### 업데이트되는 정보

- 채팅 메시지
- 운행 수락 상태 (게이지)
- 정산 정보
- 송금 완료 상태
- 방 인원 수

---

## 에러 처리

### 일반적인 에러

- 네트워크 오류 시 재시도 로직
- API 호출 실패 시 사용자에게 알럿 표시
- 에러 메시지는 사용자 친화적으로 표시

### 특수 에러

- 인원 초과: "인원이 가득 찼습니다."
- 방장 아님: "방장만 가능한 기능입니다."
- 운행 시작 전: "운행을 시작해야 작동됩니다."
- 나가기 불가: "정산이 완료되어야 채팅방을 나갈 수 있습니다."

